# dm-crypt

Подсистема ядра Linux для прозрачного шифрования блочных устройств. Является частью device mapper, использует в ядре Crypto API.

    apt install cryptsetup

## luks

Режим шифрования

Создаём пустой файл на 100 Мб (не стоит делать большой запас, так как при резервном копировании много передавать)

    dd if=/dev/urandom of=file1 bs=100M count=1 iflag=fullblock

Зашифровываем

    cryptsetup luksFormat file1

При шифровании используется алгоритм Argon2i, который намеренно требует много памяти для противодействия силовой расшифровке. Если планируется расшифровка на более слабых устройствах, то необходимо задать маленький объём памяти (например, 512 Мб) опцией `--pbkdf-memory 524288`.

Открываем (расшифровываем и создаём блочное устройство)

    cryptsetup open file1 file1

Смотрим его появление в системе

    dmsetup ls

Создаём на нём файловую систему

    mkfs.ext4 /dev/mapper/file1

Создаём папку для монтирования

    mkdir /mnt/storage

Монтируем

    mount /dev/mapper/file1 /mnt/storage

Выдаём себе права на папку

    chown user:user /mnt/storage

Полученный файл можно передавать на другие устройства с возможностью расшифровки там через cryptsetup.
При работе с данными все изменения сразу передаются в файл, который можно копировать, не закрывая через cryptsetup.

Отмонтировать

    umount /mnt/storage

Закрыть

    cryptsetup close file1